language: php

php: 
  - 5.4
  - 5.5
  - 5.6
  - "7.0"
build_image: drydock/u12phpall:tip

services:
  - mysql
  
env:
  global:
    - APP_NAME=sample-php-mysql-heroku
    - CLEARDB_DATABASE_URL=mysql://shippable@127.0.0.1:3306/test?reconnect=true
    - secure: WI5nV9jIG2Cpe9uokzwPd0NsAYjS59RPp0DYvX8xEQ11MBWsvzT0kTRtG8hShad0JTSxS4eT7DsTYUlOoV2jSn+OZcOglVsMIAWzqDdih7Hue0DZQd/JGb4BM+Kz/VnVTUXK7+0AJb3gSdBIf1SENy5IHslNrHnesg/Xr19MWPkmWg0dLrZKtK4Yte7g8f1o7dGODVeq+h7pmGKGsnSvV1ZxFxl/oyTyhZItx26ZyNt/mwBqD4yzgfHQj+dAdv0OxQLtKKghxYw/zhCnG3mMgclJYDeAveRALd7Zg5MLJK2LcZfL79h9o7h9eUZjYTpOIasMDkz4Sv2OvUBsAPDURw==
    #- secure: O3E8odLrsTMVqNaYPO3azdsHS0Q5awPt921DPN1ypmyOK+VJfJ8QUZDfSeZkOs1y3DdqOiVxCqsXmPkpNb4enqYC9tyjXutteSX6Qv4nASr4Ua5HX2CJvQlvE017J8p5ovwuHQrmgIFEOkpCZCBAius32sE49qCJtjlFFfd+LWPTFsaV4L4TKgZuDhpxx2pe5jLB2nU2xmFkRUPcAcloTVmEDZoDuYtR5Rb/ES3qJg1vxtEBoh5EsoABMeHmDNOOB6RK+5a4oqKrXo+ZAEsWXB+/gHcQrq8oYR/hRrVXcC9WRIP3aFKoT220mOGwBqsZA5+vHHPinTKPDCsDmmsCjQ==
    #- secure: QsSEyRST2AS9b/47qwdLMjvh5aRps/hVsJDR8/NxrQfBe7AXvvNTgMjb9lSTzaBFs2KM1nm0XjZbTKBeUhgFKO8PVVt7XHP+W+B0vwNIbtYaAtvdDmsF/cMk8UT0t7IU633aTE5uztN3vvCrgd27/jqMzUUHeA8fZvzqYwg2OijF2MkqleWSiRaItCsRrCGHa+gadqXJf/OXIH3wJseoaiw30mtx4o8iv/7ZhJnIr8XelaqYdVdXVRtcZb9PrgSztnuc5AIpHojOtgscvtlp3enhYDkA9HbUUo/dwbTA5gddSSadudhOBL5u3f3zfJUYDG8hEtpJEIAxhRNJI2iSpA==
  #  - secure: RfF1tcyyNlK/yn6ELFKHOe1LHLYuAQVUXY6bxlvhQvkBgu2YPj1vqDNQ3CNlGXik9mPhaYxXXoevcX/77VPHGzaRjUQ7JZH17iG/RAIiEsXb26ZIyiEwi3Q8YTsO863JI0pIkvFGkz9BhC8x4EcdaqOOZwW3JboTShIlMmltiCIX6Z/YVt0YrbaS1ZxvE6KUxkCoqor2KrUhLzqNztGjz3WILgLjkAUUV7huDcljoJlUlvUuGQwKEA0PIExPg9CjTq9cxJZblRqNGvQwgPd+jvUiZh3uTty1u7zeKnhYuJuoI60zAP6gCw2klYti+YpBL+yjlbNa5WEvZHyqZ0ievQ==

before_install:
  - which heroku || wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh

before_script: 
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - mysql -e 'create database if not exists test;'

script:
  - phpunit --log-junit shippable/testresults/junit.xml --coverage-xml shippable/codecoverage test.php

after_success:
  - test -f ~/.ssh/id_rsa.heroku || ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.heroku && heroku keys:add ~/.ssh/id_rsa.heroku
  - git remote -v | grep ^heroku || heroku git:remote --ssh-git --app $APP_NAME
  - git push -f heroku $BRANCH:master
